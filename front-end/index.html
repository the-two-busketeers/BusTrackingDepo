<html>
    <head>
        <style>
            body {
                background-color: #FFFFFF;
            }

            #title {
                text-align: center;
            }

            #search-bar {
                display: flex;
                align-items: center;
                justify-content: center;
                height: 40px;
            }

            .grid-container {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                grid-template-rows: 1fr;
                grid-gap: 1em;
                height: 60%;
            }

            .grid-element {
                background-color: gray;
                border: 1px black solid;
                padding: 1px;
                text-align: center;
            }

            .spin {
            	-webkit-animation-name: spin;
                -webkit-animation-duration: 5000ms;
                -webkit-animation-iteration-count: infinite;
                -webkit-animation-timing-function: linear;
            	animation-name: spin;
                animation-duration: 5000ms;
                animation-iteration-count: infinite;
                animation-timing-function: linear;
            }
            @keyframes spin {
            	from {
            		transform: rotate(0deg);
              	}
            	to {
                		transform: rotate(360deg);
            	}
            }

            @-webkit-keyframes spin {
                from { -webkit-transform: rotate(0deg); }
                to { -webkit-transform: rotate(360deg); }
            }

            .accordion {
                background-color: #eee;
                color: #444;
                cursor: pointer;
                padding: 18px;
                width: 100%;
                border: none;
                text-align: left;
                outline: none;
                font-size: 15px;
                transition: 0.4s;
            }

            .active, .accordion:hover {
                background-color: #ccc;
            }

            .accordion:after {
                content: '\002B';
                color: #777;
                font-weight: bold;
                float: right;
                margin-left: 5px;
            }

            .active:after {
                content: "\2212";
            }

            .panel {
                padding: 0 18px;
                background-color: white;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.2s ease-out;
            }
        </style>

    </head>

    <body>

        <div id="title">Reading Buses Depot Tracker</div>
        <div id= "search-bar">
            <input type="text" id="search">
            <select id = "select-box">
                <option value="vehicle">Vehicle ID</option>
                <option value="service">Service</option>
            </select>
        </div>
        <div class="grid-container">

            <div class="grid-element" id = "running">
            </div>

            <div class="grid-element" id = "notRunning">
                <div style="padding-top: 15%;" id ="removeDiv">
                    <img class = "spin" src="images/loading.png" width="300" height="300" alt="Logo">
                </div>
            </div>

            <div class="grid-element" id = "oldService">
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

        <script>
        var busJson = {};

        var busColors = {
            /* rgb( 13.004999999999999 , 13.004999999999999 , 13.004999999999999 )
            rgb( 255 , 0 , 0 )
            rgb( 255 , 133.875 , 0 )
            rgb( 255 , 192.01500000000001 , 0 )
            rgb( 255 , 134.895 , 0 )
            rgb( 166.005 , 166.005 , 166.005 )
rgb( 255 , 0 , 255 )
rgb( 111.94500000000001 , 47.94 , 159.885 )
rgb( 12.0105 , 121.89 , 241.99499999999998 )
rgb( 159.885 , 92.05499999999999 , 0 )
rgb( 204.0 , 153.0 , 0 )
rgb( 234.09 , 0 , 234.09 )
rgb( 41.055 , 226.95000000000002 , 27.029999999999998 )
rgb( 0 , 51.0 , 141.01500000000001 )
rgb( 91.035 , 0.9995999999999999 , 29.07 )
rgb( 0 , 102.0 , 0 )
rgb( 146.11499999999998 , 208.07999999999998 , 80.07000000000001 )
rgb( 0 , 196.095 , 79.05 )
rgb( 128.01 , 128.01 , 128.01 )
rgb( 230.01000000000002 , 0 , 230.01000000000002 )
rgb( 102.0 , 0 , 102.0 )
rgb( 173.91000000000003 , 167.025 , 159.12 )
rgb( 217.005 , 217.005 , 217.005 )
rgb( 0 , 218.025 , 98.94 )
rgb( 192.01500000000001 , 0 , 0 )
rgb( 0 , 0 , 0 )
rgb( 255 , 255 , 255 )
rgb( 0.9995999999999999 , 107.1 , 79.05 )
rgb( 248.11499999999998 , 220.065 , 0 )
rgb( 0 , 31.875 , 95.88 )
rgb( 79.05 , 75.99 , 82.11 )*/
        };



        function syncBusData(bool) {
            $.ajax({
                url: "http://192.168.152.141:5000/init",
                type: "GET",
                dataType: "json",
                crossDomain: true,
                success: function (json) {
                        busesJson = json;
                        // Do loop through each section of the json
                        if (bool === true) {
                            // remove loading circle from the running collum
                            // insert the stuff into the sections and then update the variables
                            var image = document.getElementById("removeDiv")

                            image.parentNode.removeChild(image);

                            for (var key in json) {
                                var element = document.getElementById(key)
                                var dict = json[key]
                                for(let i = 0; i < dict.length; i++){
                                    var bus = dict[i]
                                    busJson[bus.vehicle] = bus;
                                    busJson[bus.vehicle].element = CreateBusAccordion(bus, element)
                                }
                            }
                        }
                        else {
                            // do a loop through the stuff and update the data?
                                // appendChild to the correct div that we want
                        }
                    },
                    error: function (res) { console.log(res); }
                }
            )
        }

        function CreateBusAccordion(json, element) {
            var mainDiv = document.createElement("div");
            element.appendChild(mainDiv);
            var acc = document.createElement("button");
            acc.innerHTML = json.vehicle;
            var panel = document.createElement("div");

            panel.innerHTML = "Wow";

            panel.classList.add("panel");
            acc.classList.add("accordion");
            mainDiv.appendChild(acc);
            mainDiv.appendChild(panel);
            acc.addEventListener("click", function() {
                this.classList.toggle("active");
                var panel = this.nextElementSibling;
                if (panel.style.maxHeight){
                    panel.style.maxHeight = null;
                } else {
                    panel.style.maxHeight = panel.scrollHeight + "px";
                }
            });
            return mainDiv;
        }

        function busSearch(match, key) {
            for (var vehicle in busJson) {
                var bus = busJson[vehicle]
                if (match == "") {
                    bus.element.style.display = "";
                    continue;
                }
                if (bus[key].includes(match)) {
                    bus.element.style.display = "";
                }
                else {
                    bus.element.style.display = "none";
                }
            }
        }

        setInterval(syncBusData, 1000 * 30);
        syncBusData(true);

        // add selecting from the service
        // searching in the search box
        //includes(substring))
        var search = document.getElementById("search")
        var searchBox = document.getElementById("select-box")
        search.addEventListener("keyup", function(e) {
            busSearch(search.value, searchBox.options[searchBox.selectedIndex].value);
        })

    </script>

    </body>
</html>
